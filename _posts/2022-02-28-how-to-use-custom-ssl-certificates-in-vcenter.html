---
categories: ['VMware', 'vCenter']
layout: post
title: How to use custom SSL certificates in vCenter?
date: 2022-02-28 03:45:40.000000000 -05:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
- VMware
tags: []
meta:
  _aioseo_title: ''
  _aioseo_description: ''
  _aioseo_keywords: ''
  _aioseo_og_title: ''
  _aioseo_og_description: ''
  _aioseo_og_article_section: ''
  _aioseo_og_article_tags: ''
  _aioseo_twitter_title: ''
  _aioseo_twitter_description: ''
  _edit_last: '1'
  _yoast_wpseo_primary_category: '14'
  ocean_gallery_link_images: 'off'
  ocean_sidebar: '0'
  ocean_second_sidebar: '0'
  ocean_disable_margins: enable
  ocean_display_top_bar: default
  ocean_display_header: default
  ocean_center_header_left_menu: '0'
  ocean_custom_header_template: '0'
  ocean_header_custom_menu: '0'
  ocean_menu_typo_font_family: '0'
  ocean_disable_title: default
  ocean_disable_heading: default
  ocean_disable_breadcrumbs: default
  ocean_display_footer_widgets: default
  ocean_display_footer_bottom: default
  ocean_custom_footer_template: '0'
  ocean_link_format_target: self
  ocean_quote_format_link: post
  _yoast_wpseo_estimated-reading-time-minutes: '3'
  _yoast_wpseo_content_score: '60'
  _wtpsw_views: '413'
  _thumbnail_id: '1314'
  rank_math_primary_category: '14'
  rank_math_news_sitemap_robots: index
  rank_math_robots: a:1:{i:0;s:5:"index";}
  rank_math_og_content_image: a:2:{s:5:"check";s:32:"c8b19abf733e8029e75e2f8d788ab6cc";s:6:"images";a:1:{i:0;i:1284;}}
  rank_math_seo_score: '64'
  rank_math_focus_keyword: vcenter,certificate
  rank_math_internal_links_processed: '1'
  _yoast_wpseo_wordproof_timestamp: ''
permalink: "/2022/02/28/how-to-use-custom-ssl-certificates-in-vcenter/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<!-- wp:paragraph {"fontSize":"medium"} --><html><body></p>
<p class="has-medium-font-size">In this guide, we will examine the installation and update procedures for custom SSL certificates in vCenter.<br><br>1) /usr/lib/vmware-vmca/bin/certificate-manager<br>2) select option "1"</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":1284,"sizeSlug":"large","linkDestination":"none","className":"is-style-default"} --></p>
<figure class="wp-block-image size-large is-style-default"><img src="{{site.baseurl}}/assets/2022/02/image.png" alt="" class="wp-image-1284"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">3) Enter the username (default to "<mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-luminous-vivid-orange-color">Administrator@vsphere.local</mark>") and password for the user, then select option "2" to import the custom certificate and key.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":1285,"width":799,"height":144,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large is-resized"><img src="{{site.baseurl}}/assets/2022/02/vcenter1.png" alt="" class="wp-image-1285" width="799" height="144"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">4)  As per this article (<a href="https://kb.vmware.com/s/article/2112277" target="_blank" rel="noreferrer noopener">https://kb.vmware.com/s/article/2112277</a>), provide the path to all keys and all certificate files in .cer format (base64 encoded).</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"align":"left","id":1288,"width":845,"height":445,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image alignleft size-large is-resized"><img src="{{site.baseurl}}/assets/2022/02/vcenter2-1.png" alt="" class="wp-image-1288" width="845" height="445"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size"><em><span style="color:#cf2e2e" class="tadv-color"><span style="text-decoration: underline" class="underline"><strong>Note</strong>:</span></span></em> If you have one or more intermediate certificate authorities, the <code class="">root64.cer</code> should be a chain of all intermediate CA and Root CA certificates. The <code class="">machine_name_ssl.cer</code> should be a full chain for certificate+inter(s)+root.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>The machine_name_ssl.cer should be a complete chain file similar to:
-----BEGIN CERTIFICATE-----
MIIFxTCCBK2gAwIBAgIKYaLJSgAAAAAAITANBgkqhkiG9w0BAQUFADBGMRMwEQYK
CZImiZPyLGQBGRYDbmV0MRYwFAYKCZImiZPyLGQBGRYGbW5uZXh0MRcwFQYDVQQD
Ew5tbm5leHQtQUQtMS1DQTAeFw0xMzAyMDExNjAxMDNaFw0xNTAyMDExNjExMDNa 
SMhYhbv3wr7XraAnsIaBYCeg+J7fKTFgjA8bTwC+dVTaOSXQuhnZfrOVxlfJ/Ydm
NS7WBBBFd9V4FPyRDPER/QMVl+xyoaMGw0QKnslmq/JvID4FPd0/QD62RAsTntXI
ATa+CS6MjloKFgRaGnKAAFPsrEeGjb2JgMOpIfbdx4KT3WkspsK3KPwFPoYza4ih
4eT2HwhcUs4wo7X/XQd+CZjttoLsSyCk5tCmOGU6xLaE1s08R6sz9mM=
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIDZzCCAk+gAwIBAgIQNO7aLfykR4pE94tcRe0vyDANBgkqhkiG9w0BAQUFADBG
K73RIKZaDkBOuUlRSIfgfovUFJrdwGtMWo3m4dpN7csQAjK/uixfJDVRG0nXk9pq
GXaS5/YCv5B4q4T+j5pa2f+a61ygjN1YQRoZf2CHLe7Zq89Xv90nhPM4foWdNNkr 
/Esf1E6fnrItsXpIchQOmvQViis12YyUvwko2aidjVm9sML0ANiLJZSoQ9Zs/WGC
TLqwbQm6tNyFB8c=
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIDZzCCAk+gAwIBAgIQNO7aLfykR4pE94tcRe0vyDANBgkqhkiG9w0BAQUFADBG
K73RIKZaDkBOuUlRSIfgfovUFJrdwGtMWo3m4dpN7csQAjK/uixfJDVRG0nXk9pq
GXaS5/YCv5B4q4T+j5pa2f+a61ygjN1YQRoZf2CHLe7Zq89Xv90nhPM4foWdNNkr 
/Esf1E6fnrItsXpIchQOmvQViis12YyUvwko2aidjVm9sML0ANiLJZSoQ9Zs/WGC
TLqwbQm6tNyFB8c=
-----END CERTIFICATE-----
</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">5) You will now receive a prompt to replace the Machine SSL certificate using a custom certificate. Press "y" to continue the custom certificate installation in vCenter.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">You are going to replace Machine SSL cert using custom cert<br> Continue operation : Option[Y/N] ? : y</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">6) You will now receive a prompt to replace the Machine SSL certificate using a custom certificate. Press "y" to continue the custom certificate installation in vCenter.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><br>Sure, here is the English grammar correction for the text:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"style":{"typography":{"fontSize":"29px"}}} --></p>
<p style="font-size:29px"><strong><span style="text-decoration: underline" class="underline"><mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-vivid-red-color">Issues Faced When Updating Custom SSL Certificates in vCenter</mark></span></strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size"><strong><span style="text-decoration: underline" class="underline"><span style="color:#ff6900" class="tadv-color">Issue:</span></span></strong><br>The vCenter GUI was displaying the error message "No healthy Upstream" and multiple services were stopped in vCenter.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size"><span style="color:#ff6900" class="tadv-color"><span style="text-decoration: underline" class="underline"><strong>Solution:</strong></span></span></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">1) I checked the expiration dates of all certificates and found that the<strong> vsphere-webclient Solution user certificate had expired</strong>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>for store in $(/usr/lib/vmware-vmafd/bin/vecs-cli store list | grep -v TRUSTED_ROOT_CRLS); do echo "[*] Store :" $store; /usr/lib/vmware-vmafd/bin/vecs-cli entry list --store $store --text | grep -ie "Alias" -ie "Not After";done;</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">2) I attempted to reset the Solution Users certificates using the certificate-manager tool (using option "6") manually, but it failed with the error message "<mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-luminous-vivid-orange-color">Access denied, reason = rpc_s_auth_method</mark>".</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">3) I examined the VMDird log (<mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-luminous-vivid-orange-color">/var/log/vmware/vmdird/vmdird-syslog.log</mark>) and discovered password issues with the Machine account, resulting in LDAP 49 errors.<br><br><strong><span style="text-decoration: underline" class="underline">Example:</span></strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>2022-02-28T02:25:43.133044+00:00 err vmdird  t@139713625134848: SASLSessionStep: sasl error (-13)(SASL(-13): authentication failure: client evidence does not match what we calculated. Probably a password error)

2022-02-28T02:25:43.133211+00:00 err vmdird  t@139713625134848: VmDirSendLdapResult: Request (Bind), Error (LDAP_INVALID_CREDENTIALS(49)), Message ((49)(SASL step failed.)), (0) socket (192.168.1.1)

2022-02-28T02:25:43.133393+00:00 err vmdird  t@139713625134848: Bind Request Failed (172.17.10.10) error 49: Protocol version: 3, Bind DN: "<span style="color:#ff6900" class="tadv-color">cn=myvcenter.mylearningsguru.com,ou=Domain Controllers,dc=vsphere,dc=local</span>", Method: SASL</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">4) To ensure that the password for the machine account (<mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-luminous-vivid-orange-color">myvcenter.mylearningsguru.com@vsphere.local</mark>) only contains valid characters, I reset it multiple times using the vdcadmin tool provided in this link: <a href="https://kb.vmware.com/s/article/70756" target="_blank" rel="noreferrer noopener"><mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-luminous-vivid-orange-color">https://kb.vmware.com/s/article/70756</mark></a><br><br>To test if the new reset password is valid, we can use this handy command, </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>/opt/likewise/bin/ldapsearch -b "dc=vsphere,dc=local" -s sub -D "cn=myvcenter.mylearningsguru.com,ou=Domain Controllers,dc=vsphere,dc=local" -w "new-machine-account-password" &gt; /tmp/PSC_FQDN.ldif</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size"><a href="NOTE:%20This%20step%20is%20crucial%20because%20if%20the%20password%20is%20invalid,%20the%20error%20will%20persist%20even%20after%20resetting%20it.%20Therefore,%20it%20is%20essential%20to%20ensure%20the%20password%20is%20valid%20and%20free%20of%20invalid%20characters."><strong><span style="text-decoration: underline" class="underline">NOTE:</span></strong></a> This step is crucial because if the password is invalid, the error will persist even after resetting it. Therefore, it is essential to ensure the password is valid and free of invalid characters.<br></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">5) I also used the same vdcadmin tool to reset the password for the local Administrator account (<mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-luminous-vivid-orange-color">Administrator@vsphere.local)</mark>.<br>This is an <strong>optional</strong> step and is only necessary if you have forgotten the password for the local Administrator account. If you remember the password, you can skip this step.<br><br>To test if the new reset password is valid, we can again use the following command,</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>/opt/likewise/bin/ldapsearch -b "dc=vsphere,dc=local" -s sub -D "cn=Administrator,cn=Users,dc=vsphere,dc=local" -w "new-admin-account-password" &gt; /tmp/PSC_FQDN1.ldif</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">6) Used the certificate manager tool (option "4") to reset the<strong> Root CA </strong>and <strong>all other certificates</strong> with the native VMCA certificate.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">7) The replacement process was successful, and all services were restored.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">8) Imported the custom certificates again using the certificate manager tool (option "1", followed by option "2" in the next step). The Machine SSL certificate was successfully replaced with externally issued certificates.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">9) Verified that all services were running using the command "<mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-luminous-vivid-orange-color">service-control --status</mark>"</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size">10) Confirmed that the GUI was now functional and no longer displayed the error "<mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-luminous-vivid-orange-color">No healthy Upstream</mark>".</p>
<p><!-- /wp:paragraph --><br />
</body></html></p>
