---
categories: ['VMware', 'General']
layout: post
title: VMware PowerCLI update root password in all ESXi Hosts?
date: 2021-05-18 09:32:46.000000000 -04:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
- VMware
tags:
- powercli
- vmware
meta:
  _edit_last: '1'
  ocean_gallery_link_images: 'off'
  ocean_sidebar: '0'
  ocean_second_sidebar: '0'
  ocean_disable_margins: enable
  ocean_display_top_bar: default
  ocean_display_header: default
  ocean_center_header_left_menu: '0'
  ocean_custom_header_template: '0'
  ocean_header_custom_menu: '0'
  ocean_menu_typo_font_family: '0'
  ocean_disable_title: default
  ocean_disable_heading: default
  ocean_disable_breadcrumbs: default
  ocean_display_footer_widgets: default
  ocean_display_footer_bottom: default
  ocean_custom_footer_template: '0'
  ocean_link_format_target: self
  ocean_quote_format_link: post
  _yoast_wpseo_estimated-reading-time-minutes: '1'
  _yoast_wpseo_content_score: '60'
  _yoast_wpseo_primary_category: '14'
  _thumbnail_id: '712'
  _wtpsw_views: '991'
  _aioseo_title: ''
  _aioseo_description: ''
  _aioseo_keywords: ''
  _aioseo_og_title: ''
  _aioseo_og_description: ''
  _aioseo_og_article_section: ''
  _aioseo_og_article_tags: ''
  _aioseo_twitter_title: ''
  _aioseo_twitter_description: ''
  rank_math_primary_category: '14'
  rank_math_news_sitemap_robots: index
  rank_math_robots: a:1:{i:0;s:5:"index";}
  rank_math_internal_links_processed: '1'
  _yoast_wpseo_wordproof_timestamp: ''
permalink: "/2021/05/18/vmware-powercli-update-root-password-in-all-the-esxi-host/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<!-- wp:heading {"fontSize":"medium"} --><html><body></p>
<h2 class="has-medium-font-size">
<span style="text-decoration: underline" class="underline"><span style="color:#fcb900" class="tadv-color">Script to change a common password of all the ESXIs in a vCenter:</span></span>  </h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>#need to enter the current root password at command line
<span style="color:#313131" class="tadv-color">$rootpswd = read-host "Please enter the current root password"
</span>
#need to enter the new root password at command line 
<span style="color:#313131" class="tadv-color">$newpass = read-host "Please enter the new root password"</span>

#vCenter you are working in, enter the vCenter name at the command line
<span style="color:#313131" class="tadv-color">$vcenter = read-host "Please enter the name of the vCenter you will be working in"</span>

#connect to the VC (<strong>At this step, you will be prompted to enter the vcenter credentials)</strong>
<span style="color:#313131" class="tadv-color">connect-viserver $vcenter</span>

#creates your list of ESXI hosts from the vCenter.
<span style="color:#313131" class="tadv-color">$vihosts = get-vmhost
</span>
#loops through your hosts  
<span style="color:#313131" class="tadv-color">foreach ($vihost in $vihosts){

       Connect-VIServer $vihost -User root -Password $rootpswd -ErrorAction SilentlyContinue -ErrorVariable ConnectError | Out-Null</span>
<span style="color:#313131" class="tadv-color">
       if ($ConnectError) {
               Write-host "failed to connect to $vihost...trying next host..." -foregroundcolor Yellow
               Write-output "$vihost" | out-file -Append -filepath "/home/madhu/failed_to_connect.txt"
                           }
       Else {
       Set-VMHostAccount -UserAccount root -Password $newpass | Out-Null
       Disconnect-VIserver -server $defaultVIServer -confirm:$false -Force
       Write-Host "Password changed for $vihost...moving to next host..." -foregroundcolor Yellow
               }
}

Write-Host "Script complete....check /home/madhu/failed_to_connect.txt for failed hosts" -foregroundcolor white</span>
</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:tadv/classic-paragraph /--></p>
<p><!-- wp:tadv/classic-paragraph --></p>
<p> </p>
<p> </p>
<p><!-- /wp:tadv/classic-paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2><span style="text-decoration: underline" class="underline"><span style="color:#fcb900" class="tadv-color">Script to change a common password in a list of ESXi not in a vCenter</span></span></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>#need to enter the current root password at command line
<span style="color:#313131" class="tadv-color">$rootpswd = read-host "Please enter the current root password"</span>

#need to enter the new root password at command line 
<span style="color:#313131" class="tadv-color">$newpass = read-host "Please enter the new root password"</span>

#list of ESXIs
<span style="color:#313131" class="tadv-color">$vihosts = @('myesxi1','myesxi2','myesxi3','myesxi4','myesxi5','myesxi6','myesxi7','myesxi8','myesxi9')</span>

#loops through your hosts  
<span style="color:#313131" class="tadv-color">foreach ($vihost in $vihosts){

       Connect-VIServer $vihost -User root -Password $rootpswd -ErrorAction SilentlyContinue -ErrorVariable ConnectError | Out-Null

       if ($ConnectError) {
               Write-host "failed to connect to $vihost...trying next host..." -foregroundcolor Yellow
               Write-output "$vihost" | out-file -Append -filepath "/home/madhu/failed_to_connect.txt"
                           }
       Else {
       Set-VMHostAccount -UserAccount root -Password $newpass | Out-Null
       Disconnect-VIserver -server $defaultVIServer -confirm:$false -Force
       Write-Host "Password changed for $vihost...moving to next host..." -foregroundcolor Yellow
               }
}

Write-Host "Script complete....check /home/madhu/failed_to_connect.txt for failed hosts" -foregroundcolor white</span>

</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:tadv/classic-paragraph --></p>
<p> </p>
<p> </p>
<p><!-- /wp:tadv/classic-paragraph --></p>
<p><!-- wp:heading {"style":{"typography":{"fontSize":22}}} --></p>
<h2 style="font-size:22px"><span style="color:#fcb900" class="tadv-color"><span style="text-decoration: underline" class="underline">$defaultVIServer</span></span></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:tadv/classic-paragraph --></p>
<p><span style="font-size: 20px;">When you connect to a vCenter/ESXI using the <strong>Connect-VIServer</strong> cmdlet, the DefaultVIServer variable is configured to the name of that vCenter/ESXI.</span></p>
<p><span style="font-size: 20px;">Consequently, when you execute PowerCLI cmdlets (such as <strong>Set-VMHostAccount</strong> in our script) without utilizing the <strong>-Server</strong> parameter and the target vCenter/ESXI cannot be determined, the cmdlet defaults to using the vCenter/ESXI specified in the <strong>DefaultVIServer</strong> variable for the query.</span></p>
<p><span style="font-size: 20px;">Upon disconnecting from the vCenter using <strong>Disconnect-VIServer</strong>, the <strong>DefaultVIServer</strong> variable becomes empty.</span></p>
<p><!-- /wp:tadv/classic-paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:spacer {"height":"98px"} --></p>
<div style="height:98px" aria-hidden="true" class="wp-block-spacer"></div>
<p><!-- /wp:spacer --></p>
<p><!-- wp:heading {"style":{"typography":{"fontSize":22}}} --></p>
<h2 style="font-size:22px"><span style="text-decoration: underline" class="underline"><span style="color:#fcb900" class="tadv-color">$defaultVIServers</span></span></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:tadv/classic-paragraph --></p>
<p><span style="font-size: 20px;">We have the ability to connect to multiple ESXI/vCenter servers by utilizing the '<strong>Connect-VIServer</strong>' command. Each connection gets stored in an array variable along with previously connected servers, unless the NotDefault parameter is specified.</span></p>
<p><span style="font-size: 20px;">This array variable is denoted as <strong>$DefaultVIServers</strong>, and its initial value is an empty array.</span></p>
<p><span style="font-size: 20px;">The <strong>NotDefault</strong> parameter allows exclusion of the connected server from the <strong>$DefaultVIServers</strong> variable.</span></p>
<p><span style="font-size: 20px;">When executing a cmdlet (such as <strong>Set-VMHostAccount</strong> in our script) and the target servers cannot be identified from the specified parameters, the cmdlet operates against all servers stored in the array variable.</span></p>
<p><span style="font-size: 20px;">To remove a server from the <strong>$DefaultVIServers</strong> variable, there are two methods: either use <strong>Disconnect-VIServer</strong> to close all active connections to the server, or manually modify the value of<strong> $DefaultVIServers</strong>.</span></p>
<p><br><br><br></p>
<p> </p>
<p><!-- /wp:tadv/classic-paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --><br />
</body></html></p>
